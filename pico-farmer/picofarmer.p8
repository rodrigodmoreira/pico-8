pico-8 cartridge // http://www.pico-8.com
version 27
__lua__
-- init
function _init()
	_update60=gm_upd
	_draw=gm_drw
	
	init_map()
	
	p1=player:new(32,32)
end

function init_map()
	for i=0, 50 do
		for j=0, 50 do
			mset(i,j, 125+rnd(3))
		end
	end
end

-->8
-- update
function gm_upd()
	p1:update()
end

-->8
-- draw
function gm_drw()
	cls()
	camera(p1.pos.x-63, p1.pos.y-63)

	-- draw approximately only what is seen on screen
	map(
		-- map top-left
		flr((p1.pos.x-63)/8),flr((p1.pos.y-63)/8),
		-- world top-left
		p1.pos.x-63,p1.pos.y-63,
		-- nmb of tiles to draw
		16,16
	)
	p1:draw()
	
	-- ui
	camera()
	print(p1.pos.x.."/"..p1.pos.y, 0,0, 1)
end
-->8
-- class
player={
	anim={
		{0, 1, 2}, -- idle
		{3, 2, 0, 4, 2, 0}, -- walk
		{5, 6}, -- interaction
	},
	new=function(self, x,y)
		local o={
			pos=vec2:new(x or 0 ,y or 0),
			-- 1 => idle
			-- 2 => walk
			-- 3 => interaction
			state=1,
			anim_spd=6,
			flip_x=false
		}
		set_index(o, self)
		return o
	end,
	update=function(self)
		-- input
		local axis=vec2:new(
			_t(btn(0), -1, 0) + _t(btn(1), 1, 0),
			_t(btn(2), -1, 0) + _t(btn(3), 1, 0)
		)

		if axis.x != 0 or axis.y != 0 then
			self.state=2
			self.anim_spd=12
			if ((time()*1000)%1==0) sfx(0,0)
		else
			self.state=1
			self.anim_spd=6
		end

		if axis.x < 0 then self.flip_x=true
		elseif axis.x > 0 then self.flip_x=false end
		
		self.pos=self.pos:add(axis)
	end,
	draw=function(self)
		local frames=self.anim[self.state]
		spr(
			frames[1+sequence(#frames,self.anim_spd)],
			self.pos.x, self.pos.y, 1,1, self.flip_x
		)
	end
}

vec2={
	new=function(self, x,y)
		local o={x=x or 0,y=y or 0}
		set_index(o, self)
		return o
	end,
	add=function(self,v)
		return vec2:new(self.x+v.x, self.y+v.y)
	end
}

-- utilities
function check_coll(v0, v1)
	return v0.x<=v1.x+8 and
								v0.x+8>=v1.x and
								v0.y<=v1.y+8 and
								v0.y+8>=v1.y
end

function _t(c, a,b)
	return c and a or b
end

function set_index(obj, tb)
	setmetatable(obj, {__index=tb})
end

function sequence(max_value, spd)
	return flr(time()*(spd or 1))%max_value
end
__gfx__
00000000005770000057700000577000005770000000000000000000000000000000000000000000077700000007700000070000000000000000000000000000
00577000005555000055550000555500005555000000000000000000000000000000000000000000000777000000077000000700000007000000000000000000
0055550000dff00000ddd00000dff00000dff0000000000000000000000000000000000000000000000077700000007700000070000000000000000000000000
00dff0000088800000dff00000f880000ff880000000000000000000000000000000000000000000000007700000007700000077000000070000000000770000
0088800000f880000088800000ff80000f888f000008d5500008d550000000000000000000000000000000000000077700000777000000700770070000770000
00f8800000f8800000f8800001111d000011100000f8f7700088f770000000000000000000000000000000000000777700077777077777700777700000077000
00f110000011100000f1100000000000000d000000f88550008f8550000000000000000000000000000000000000777000777770077777000077000000000000
0010d0000010d0000010d000000000000000000001111f00011f1000000000000000000000000000000000000000000000777700007770000000000000000000
00000000000999000009990000999000009990000000000000000000000000000000000000000000000000000000000000000000000000000000000077077077
0009990000aaaaa000aaaaa00aaaaa000aaaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000070000007
00aaaaa00001ff0004411100441ff000441ff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0441ff00045566000451ff00455660004f5660000000000000000000000000000000000000000000000000000000000000000000000000000000000070000007
04556600045f66000555660055ff60005f666f000000000000000000000000000000000000000000000000000000000000000000000000000000000070000007
055f6600055f6600044f660041111d00441110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
044f110004411100000f110000000000000d00000000000000000000000000000000000000000000000000000000000000000000000000000000000070000007
00010d0000010d0000010d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000077077077
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008a8888882800000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008a8a828228280000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008aaa8888882228000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008aa8a8888882122800000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008aa8aa8888882212280000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008aa8aa8aa8a828221228000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008aa8aaaa8888882222122800000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000008aa8aaa8a8888882122212280000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa8aaa8aa8888882212221220000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a8aaa8aa8a828228221222120000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000008aaa8aaaa8888882222122210000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aaa8aaa8a8888882122212220000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa8aaa8aa8888882212221220000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a8aaa8aa8aa8a828221222120000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000008aaa8aaaa8888882222122210000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aaa8aaa8a8888882122212220000000000000000
000000000000777b7bbb00000000000000000000000000000000000000000000000000005000000bb0000005aa8aaa8a22222222812221220000000000000000
000000000077bbbbbbbbbb00000000000000000000000000000000000000000000000000511515b7bb555515a8aaa8a244444444181222120000000000000000
0000000007bbbbbbb7b77bb000000000000000000000000000000000000000000000000050000bbbb3b000058aaa8a24f4ffffff418122210000000000000000
0000000007bbbbbbbbb77bb00000000000000000000000000000000000000000000000005000bbb7b33b0005aaa8824ff4fffffff41212220000000000000000
000000007b7b77bbbbbbbbbb000000000000000000000000000000000000000000000000500bbbbbb333b005aa8a24ff4f44f4ffff4181220000000000000000
000000007bbb7777b77bb7bb00000000000000000000000000000000000000000000000050bbbbb7b3333305a8824ffffffffffffff412120000000000000000
00000000b773bb777777b3bb0000000000000000000000000000000000000000000000005bbbbbb7b33333358a24ffffffffffffffff41810000000000000000
00000000b773bb33bb3b333b000000000000000000000000000000000000000000000000bbbbbbb7b3333333824ffffffffffffffffff4120000000000000000
00000000b333333333333b3b000000000000000000000000000000000000000000000000bbbbbb7bb333333324ffffffffffffffffffff418444444884500008
00000000b33bb3b333bb333b000000000000000000000000000000000000000000000000bbbbb7b55b3333334ffffffffffffffffffffff48555555885c00008
000000000b3bb31133bb33b0000000000000000000000000000000000000000000000000bbbb7b3535b33333ffffffffffffffffffffffff8557c55885460008
0000000000bb33111133bb00000000000000000000000000000000000000000000000000bbbbb333b35b3333ff4fffffffffffffffff4fff85c44c5885500008
000000000000005111000000000000000000000000000000000000000000000000000000bb7b333b3b35b33344444f4ffffffffff4f4444f8555555885400008
000000000000005555000000000000000000000000000000000000000000000000000000b7b333bb3bb35b33fff4fffffffffffffffff4ff8544465885411108
000000000000065555600000000000000000000000000000000000000000000000000000bb333bbb3bbb35b3f44f44fffffffffffff44f448544445885511118
000000000000655555560000000000000000000000000000000000000000000000000000b333bbb3bbbbb35bffffffffffffffffffffffff8555555885111118
000000000000000bbbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000
000000000007bbb3bb3bbb7000000000000000000000000000000000000007000000000000000000000000000000000000000000000aa0000000000000000000
00000000000b77bb33bb77b00000000000000000000000000000000000007b000000000000000000000000000000000000000000000090000000000000000000
00000000000bbb3bbb73bbb0000000000000000000000000000000000070bb0000000000000000000b0b0b0b00000000000000000aa090000000a00000000000
00000000000bbb3b77b3bbb00000000000000000000000000000000007b031000000000000000000003000300b0b0b0b0000000000a090aa0000b00000000000
00000000000bb03bbbb990b0000000000000000000000000000000000bb0bb00000000000000b0000440005400300030030303030090909000a0300000000000
000000000000b033bba9a90000000007b700000000000000000000000310bb00000000000b0030000455055404400054003000300090909000b030b00000b000
00000000000000339b9a9a00000007b3b3b7000000000000000000000bb03100000007000300b000055404550455055400450540009090900030303000b03030
00000000000003339a9a9a000000bb7b3b7bb00000000000000000000bb0bb0000007b0022111111212222112222222222222222333333333333333333333333
00000000000003309a9a50000000bb377b3bb00000000000000000000310bb000070bb0021221121224422412222242222222222333333333333333333333333
0000000000000330505000000000b00bbb00b00000000000000000000bb0310007b0310012112221242244422222222222222222333333333bb3333333333333
00000000000003300000000000000003bb0000000000000bb70000000bb0bb000bb0bb0012112211242244222244222222222222333a33333bb333b333333333
00000000000033300000000000000003b000000000000077b37000000310bb000310310011222221114444422244222222222222333b3a333333333333333333
00000000000033b3000000000000003300000000000000b3773000000bb031000bb0bb0012122221142444422222242222222222355b5b333b33bb3333333333
00000000000033bb000000000000003b00000000000000337b0000000bb0bb000310310012221212244424222442222222222222333333333333bb3333333333
0000000000003bbb000000000000003b0000000000000003b00000000310bb000bb0bb0021122121212442212442222222222222333333333333333333333333
__map__
7f7f7f7f7f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
7f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
7f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
7f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
010100000f1200e600014000060001600016000160018600000001960000000000001a600000001b600000001b60000000000001c600000001c6001d6001d6001d60000000000000000000000000000000000000
