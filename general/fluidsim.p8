pico-8 cartridge // http://www.pico-8.com
version 30
__lua__
-- init

res=52
delay_ct=0

function _init()
	grid = gridmap:new(res)
	target = {x=64, y=64}
end
-->8
-- update
function _update60()
	update_target()
	if delay_ct % 5 == 0 then
		grid:update()
	end
	delay_ct += 1
end

function update_target()
	local axis={x=0,y=0}
	if btn(2) then
		axis.y -= 1
	end
	if btn(3) then
		axis.y += 1
	end
	if btn(0) then
		axis.x -= 1
	end
	if btn(1) then
		axis.x += 1
	end
	if btn(4) then
		local y = flr((target.x+4)/grid.rect_size)
		local x = flr((target.y+4)/grid.rect_size)
		if x >= 0 and x < grid.res and y >= 0 and y < grid.res and grid.cells[x][y] >= 0 then
			grid.cells[x][y] = 3
		end
	end

	target.x += axis.x
	target.y += axis.y
end

-->8
-- draw
function _draw()
	cls()
	grid:draw()

	line(target.x, target.y - 3, target.x, target.y + 3, 8)
	line(target.x - 3, target.y, target.x + 3, target.y, 8)
	print(target.x.."/"..target.y, 5,5, 10)
end

-->8
-- utils
gridmap={
	new=function(self, res)
		local o={}

		o.res = res or 128
		o.rect_size = flr(128.0/res)
		o.cells = {}
		for i=1, o.res do
			for j=1, o.res do
				if o.cells[i] == nil then
					o.cells[i]= {}
				end

				local map_cell = mget(j-1, i-1) -- load from map
				if i==1 or i==res or j==1 or j==res or map_cell > 0 then -- solid (+border)
					o.cells[i][j] = -1
				else
					o.cells[i][j] = 0
				end
			end
		end

		setmetatable(o, self.mt)
		return o
	end,
	prototype={
		draw=function(self)
			for i, row in ipairs(self.cells) do
				for j, col in ipairs(row) do
					local switch = {5,6,7}
					switch[0] = 0
					switch[-1] = 1
					local color = switch[col]
					rectfill(
						(j-1)*self.rect_size,(i-1)*self.rect_size,
						(j)*self.rect_size,(i)*self.rect_size,
					color)
				end
			end
		end,
		update=function(self)
			for i, row in ipairs(self.cells) do
				if i > 1 and i < self.res then
					for j, p in ipairs(row) do -- particles_number
						if j > 1 and j < self.res then
							local below = self.cells[i+1][j]
							local left = self.cells[i][j-1]
							local right = self.cells[i][j+1]

							local function is_valid_cell(cell)
								return cell > -1 and cell < 3
							end

							local function move_cell(c0_x, c0_y, c1_x, c1_y)
								-- local available = 3-self.cells[c1_y][c1_x]
								self.cells[c0_y][c0_x] -= 1
								self.cells[c1_y][c1_x] += 1
							end

							if p > 0 then
								-- vertical
								if is_valid_cell(below) then -- not solid and has space
									move_cell(j,i, j,i+1)
								else
									-- sideways
									if left < right and is_valid_cell(left) then -- 
										move_cell(j,i, j-1,i)
									elseif is_valid_cell(right) then
										move_cell(j,i, j+1,i)
									end
								end
							end
						end
					end
				end
			end
		end
	}
}
gridmap.mt={
	__index=gridmap.prototype
}

__gfx__
0000000009aa009a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000009aa009aa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700aa009aa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000a009aa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000009aa0090000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070009aa009a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000009aa009aa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000aa009aa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000001010101010000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000001000000000000000100000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000001000000000000000100000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000100000001000001000000000000000100000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000101000101000001010101010101010100000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
